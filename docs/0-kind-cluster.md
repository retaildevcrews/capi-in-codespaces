# Provision a kind cluster using CAPI and the CAPD provider

## kind

Cluster API requires an existing Kubernetes cluster accessible via kubectl. During the installation process the Kubernetes cluster will be transformed into a management cluster by installing the Cluster API provider components, so it is recommended to keep it separated from any application workload.

A workload cluster configuraton with 1 control plane and 1 worker machine is generated as part of the Codespaces setup. It creates a YAML file named `capi-quickstart.yaml` with a predefined list of Cluster API objects; Cluster, Machines, Machine Deployments, etc.

  > The following command is run to transform a cluster in its initial state to a management cluster:
  >> **Note**
  >> This command was run as part of the codespace setup so provided for reference
  >
  > ```bash
  >
  > export CLUSTER_TOPOLOGY=true
  > clusterctl init --infrastructure docker
  >
  > ```
  >
  > The cluster configuration can be generated by running:
  >> **Note**
  >> This command was run as part of the codespace setup so provided for reference, but can also be used to regenerate the configuration file
  >
  > ```bash
  >
  > clusterctl generate cluster capi-quickstart --flavor development \
  > --kubernetes-version v1.26.0 \
  > --control-plane-machine-count=1 \
  > --worker-machine-count=1 \
  > > capi-quickstart.yaml
  >
  > ```

## Lab Steps

1. See what pods are running as a result of creation and initialization of the management cluster that was part of the Codespaces setup:

    ```bash

    kubectl get pods -A

    ```

2. The `clusterctl` CLI tool handles the lifecycle of a Cluster API management cluster. Ensure an up-to-date version of the CLI installed to your GH Codespaces:

    ```bash

    clusterctl version

    ```

3. Open the file to review the contents.

    ```bash

    code capi-quickstart.yaml

    ```

4. When ready, run the following command to apply the cluster manifest.

    ```bash

    kubectl apply -f capi-quickstart.yaml

    ```

5. Refresh the browser tab for the Visualizer app to view the latest changes.

6. Access the workload cluster:

    ```bash

    # validate the workload cluster
    kubectl get cluster

    # validate cluster and its resources
    clusterctl describe cluster capi-quickstart

    # verify the control plane is up
    # INITIALIZED column should be true
    kubectl get kubeadmcontrolplane

    ```

7. After the control plane node is up and running, we can retrieve the workload cluster Kubeconfig:

    ```bash

    clusterctl get kubeconfig capi-quickstart > capi-quickstart.kubeconfig

    # update KUBECONFIG so kubectl can access the different config files.
    # useful for easily switching kube contexts
    export KUBECONFIG=~/.kube/config:/workspaces/capi-in-codespaces/capi-quickstart.kubeconfig

    kubectl config rename-context capi-quickstart-admin@capi-quickstart capi-quickstart

    # verify kubectl has access to the new context
    kubectl config get-contexts

    ```

8. The control plane wonâ€™t be `Ready` until we install a CNI, deploy a CNI solution by running:

   ```bash

   kubectl --context=capi-quickstart \
   apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.24.1/manifests/calico.yaml

   ```

9. After a short while, nodes should be running and in `Ready` state, check the status of workload cluster by running:

    ```bash

    kubectl --context=capi-quickstart get nodes

    ```

> **Note**
> For further experimentation and education, follow [this quickstart](https://cluster-api.sigs.k8s.io/user/quick-start.html) for the manual setup of CAPI and workload clusters

**NEXT LAB:** [Lab 2 - Provision AKS Cluster using CAPI and the Azure Provider](./docs/1-managed-aks-cluster.md)
